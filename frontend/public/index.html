<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Palace of Goods</title>
  <script src="https://sdk.minepi.com/pi-sdk.js" async></script> <!-- Pi Network SDK -->
</head>
<body>
  <div id="root"></div>

  <script>
    // Initialize Pi SDK on document load
    document.addEventListener("DOMContentLoaded", () => {
      Pi.init({
        version: "2.0",
        sandbox: true,  // Change to false in production
        appId: "your_pi_network_sdk_key"  // Replace with your actual app ID
      });
    });

    // Authentication for Pi payments
    const scopes = ['payments'];

    Pi.authenticate(scopes, (payment) => {
      const paymentId = payment.identifier;
      const txid = payment.transaction.txid;
      const accessToken = payment.access_token;  // Using the token returned after successful authentication

      fetch('/payment/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ paymentId, txid, accessToken })
      })
      .then(response => response.json())
      .then(data => {
        console.log('Payment completed:', data);
      })
      .catch(error => {
        console.error('Error completing payment:', error);
        handleError(error);
      });
    }).catch((error) => {
      console.error('Authentication error:', error);
      handleError(error);
    });

    // Handle errors in a user-friendly way
    function handleError(error) {
      alert('There was an issue with your payment: ' + error.message);
    }

    // Create payment with metadata and initiate the payment flow
    function createPayment() {
      const paymentData = {
        amount: 0.01,  // Payment amount
        memo: "Purchase from Palace of Goods",
        metadata: { itemId: 123456 }  // Example metadata, adjust based on actual product data
      };

      const paymentCallbacks = {
        onReadyForServerApproval: (paymentDTO) => {
          fetch('/payment/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              paymentId: paymentDTO.identifier,
              accessToken: "user_access_token"  // Securely fetch token here
            })
          })
          .then(response => response.json())
          .then(data => {
            console.log('Payment approved:', data);
          })
          .catch(error => handleError(error));
        },
        onReadyForServerCompletion: (paymentDTO, txid) => {
          fetch('/payment/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId: paymentDTO.identifier, txid })
          })
          .then(response => response.json())
          .then(data => {
            console.log('Payment completed:', data);
          })
          .catch(error => handleError(error));
        },
        onCancel: (paymentDTO) => {
          fetch('/payment/cancel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId: paymentDTO.identifier })
          })
          .then(response => response.json())
          .then(data => {
            console.log('Payment cancelled:', data);
          })
          .catch(error => handleError(error));
        },
        onError: (paymentDTO) => {
          handleError(paymentDTO);
        }
      };

      Pi.createPayment(paymentData, paymentCallbacks);
    }
  </script>
</body>
</html>
